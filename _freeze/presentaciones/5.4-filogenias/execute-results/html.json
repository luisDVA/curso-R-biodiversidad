{
  "hash": "c2019ff3336e2bbb344546a1e9d442a6",
  "result": {
    "markdown": "---\ntitle: \"Filogenias en R\"\nauthor: Axel Arango & Fabricio Villalobos\nformat: revealjs\n---\n\n\n## Filogenias en R\n\n\n::: {.cell}\n\n:::\n\n\nPrimero, ¿Qué es un árbol Filogenético?\n\n##\n\nUn árbol filogenético es un diagrama que muestra la relación de parentezco entre especies (o taxones)\n\n##\n\nUno de los formatos más utilizados para representar filogenias son el *Newick*(.tree)\n\nEl formato Newick es una notación para representar parentescos utilizando parentesis y comas.\n\n##\n\nSi queremos decir que A y B se parecen más entre ellos que con X, lo anotaríamos así:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n\"((A,B),X);\"\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"((A,B),X);\"\n```\n:::\n:::\n\n\n\n##\n\nPara que *R* pueda identificar está notación, se puede usar `ape`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ape)\nread.tree(text=\"((A,B),X);\") %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/newick-1.png){width=960}\n:::\n:::\n\n\n##\n\nEl formato Newick es anidado, por lo que podemos explorar la relación entre diferentes grupos. Por ejemplo:\n\nSabemos que los lobos, los coyotes y los zorros pertenecen a Canidae, pero que los lobos y los coyotes son del mismo género\n\n\n::: {.cell}\n\n```{.r .cell-code}\nCanidae <-\"(Vulpes_vulpes,(Canis_lupus,Canis_latrans));\"\nread.tree(text=Canidae) %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/canii-1.png){width=960}\n:::\n:::\n\n\n\n##\n\nY si agregamos murciélagos, todos ellos pertenecen a los mamíferos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMammalia <-\"(Desmodus_rotundus,(Vulpes_vulpes,(Canis_lupus,Canis_latrans)));\"\nread.tree(text=Mammalia) %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/murcis-1.png){width=960}\n:::\n:::\n\n\n\n##\n\nSi quisieramos agregar cuervos y zanates. ¿Estos dónde irían?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntetrapoda<-\"((Quiscalus_mexicanus,Corvus_corax),(Desmodus_rotundus,(Vulpes_vulpes,(Canis_lupus,Canis_latrans))));\"\n\nread.tree(text=tetrapoda) %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/zan-1.png){width=960}\n:::\n:::\n\n\n##\n\nY si agregamos una planta, los mamíferos y las aves se anidarían.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nEukarya<-\"(Sideroxylon_celastrinum,((Quiscalus_mexicanus,Corvus_corax),(Desmodus_rotundus,(Vulpes_vulpes,(Canis_lupus,Canis_latrans)))));\"\n\nNktree<-read.tree(text=Eukarya)\nplot(Nktree)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/planta-1.png){width=960}\n:::\n:::\n\n\n##\n\n-   En este ejercicio haremos uso del paquete *ggtree* para graficar, personalizar, anotar y en general mejorar árboles filogenéticos\n\n## Paquetes necesarios:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ape)\nlibrary(ggtree)\nlibrary(deeptime)\nlibrary(tidytree)\nlibrary(ggimage)\nlibrary(geiger)\nlibrary(caper)\nlibrary(TDbook)\nlibrary(here)\n```\n:::\n\n\n## \n\nEn este caso usaremos un árbol filogenético en particular (la filogenia de *Icteridae*). Sin embargo, estos ejemplos se pueden hacer en su mayoría con cualquier otra filogenía que tengan disponible.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree <-read.tree(here(\"data\",\"Icteridae_tree.txt\"))\nictree\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nPhylogenetic tree with 100 tips and 99 internal nodes.\n\nTip labels:\n  Icterus_melanopsis, Icterus_northropi, Icterus_laudabilis, Icterus_dominicensis, Icterus_cayanensis, Icterus_pyrrhopterus, ...\nNode labels:\n  761, 762, 763, 764, 765, 766, ...\n\nRooted; includes branch lengths.\n```\n:::\n:::\n\n\n## \n\nVeamos esta filogenia graficandola usando *ape*, la manera base para R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(ictree, show.tip.label=F)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-7-1.png){width=960}\n:::\n:::\n\n\n## \n\nAhora graficaremos el mismo árbol utilizando ggtree, el cual sigue una formula idéntica a la de ggplot. Nuestro árbol base se llamará *p1*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1<-ggtree(ictree,color=\"black\",size=0.5)\nplot(p1)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n\n## \n\nCon *p1*, al igual que con cualquier otro gráfico de ggplot, podemos agregar parametros de graficación para personalizar o agregar anotaciones a nuestra filogenia. Primero empezaremos con los parametros de personalización. Por ejemplo, podemos cambiar la disposición de la filogenia utilizando el parametro *layout\\_*:\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+layout_dendrogram()+\np1+layout_fan()+\np1+layout_circular()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-9-1.png){width=960}\n:::\n:::\n\n\n## \n\nTambién podemos cambiar el color del fondo del gráfico\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  theme_tree(bgcolor=\"lightblue\")\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-10-1.png){width=960}\n:::\n:::\n\n\n## \n\nAgregar las etiquetas para las puntas de una manera personalizable:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  geom_tiplab(size=1,color=\"darkblue\",angle=10)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-11-1.png){width=960}\n:::\n:::\n\n\n## \n\nformas a las puntas:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  geom_tippoint(size=1,color=\"brown\",shape=10)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-12-1.png){width=960}\n:::\n:::\n\n\n## \n\nEtiquetas a los nodos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+ \n  geom_nodelab(size=1,color=\"purple\")\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-13-1.png){width=960}\n:::\n:::\n\n\n## \n\no formas a los nodos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+ \n  geom_nodepoint(size=2,color=\"red\",shape=16)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n\n\n## \n\ne incluso agregar una escala temporal a la filogenia, con la ayuda del paquete `deeptime`\n\n\n::: {.cell}\n\n```{.r .cell-code}\npy<-revts(p1)\npy+coord_geo(xlim=c(-10,-1),abbrv = F,neg=T,skip=NULL,dat=\"stage\",size=1.5)+\n  theme_tree2()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-15-1.png){width=960}\n:::\n:::\n\n\n## \n\nCómo en ggplot, todos estos parámetros son aditivos, por lo cual puedes construir la filogenía de manera gradual\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+ \n  layout_dendrogram()+\n  theme_tree(bgcolor=\"#e9f0ea\")+\n  geom_tiplab(size=0.5,color=\"darkblue\",angle=45)+\n  geom_tippoint(size=1,color=\"brown\",shape=10)+\n  geom_nodelab(size=1,color=\"purple\")+\n  geom_nodepoint(size=2,color=\"red\",alpha=0.3,shape=16)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-16-1.png){width=960}\n:::\n:::\n\n\n## \n\nAhora para la anotación de los árboles, se pueden hacer varias cosas, a mi, por ejemplo, me gusta mucho el género *Quiscalus*, y quisiera saber donde se encuentra en la filogenia.\n\n##\n\nPara esto primero debemos encontrar el nodo del ancestro en común más reciente para este grupo. Usando un *tibble* y la estructura de *dplyr* es muy facil, primero transformamos nuestro árbol en un tibble y despues utilizando un filtro buscamos las especies de *Quiscalus*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree %>%\nas_tibble %>%\n  filter(grepl(\"Quiscalus\",label))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 4\n  parent  node branch.length label                  \n   <int> <int>         <dbl> <chr>                  \n1    146    41         1.82  Quiscalus_quiscula     \n2    148    42         0.851 Quiscalus_niger        \n3    149    43         0.335 Quiscalus_major        \n4    149    44         0.335 Quiscalus_mexicanus    \n5    150    45         1.02  Quiscalus_nicaraguensis\n6    150    46         1.02  Quiscalus_lugubris     \n```\n:::\n:::\n\n\n## \n\nDespués usando la función *MRCA* podemos encontrar el ancestro en común de estas especies, en las cuales podemos usar los nombres de las especie con la longitud de rama más alargada y con la longitud de rama más corta, o sus nodos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree %>%\nas_tibble %>%\nMRCA(41,43)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 4\n  parent  node branch.length label\n   <int> <int>         <dbl> <chr>\n1    144   146          1.37 806  \n```\n:::\n:::\n\n\n. . .\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree %>%\nas_tibble %>%\nMRCA(\"Quiscalus_quiscula\",\"Quiscalus_mexicanus\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 4\n  parent  node branch.length label\n   <int> <int>         <dbl> <chr>\n1    144   146          1.37 806  \n```\n:::\n:::\n\n\n## \n\nAhora sabiendo que el ancestro en común de *Quiscalus* se encuentra en el nodo 146, puedo utilizar esta información para anotar la filogenia utilizando el parametro *geom_cladelab*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  geom_cladelab(node=146,label = \"Quiscalus\",offset=0,\n            barcolor=\"red\",textcolor=\"brown\",\n            angle=90, offset.text=0.1)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\n## \n\ny que tal el genero que tiene el nombre de la familia: *Icterus*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree %>%\n  as_tibble %>%\n  filter(grepl(\"Icterus\",label))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 31 × 4\n   parent  node branch.length label                \n    <int> <int>         <dbl> <chr>                \n 1    111     1         0.193 Icterus_melanopsis   \n 2    111     2         0.193 Icterus_northropi    \n 3    114     3         1.47  Icterus_laudabilis   \n 4    114     4         1.47  Icterus_dominicensis \n 5    116     5         0.197 Icterus_cayanensis   \n 6    116     6         0.197 Icterus_pyrrhopterus \n 7    115     7         0.943 Icterus_auricapillus \n 8    117     8         1.49  Icterus_bonana       \n 9    117     9         1.49  Icterus_portoricensis\n10    118    10         2.24  Icterus_prosthemelas \n# ℹ 21 more rows\n```\n:::\n:::\n\n\n. . .\n\n\n::: {.cell}\n\n```{.r .cell-code}\nictree %>%\nas_tibble %>%\nMRCA(25,14)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 4\n  parent  node branch.length label\n   <int> <int>         <dbl> <chr>\n1    103   104          2.92 764  \n```\n:::\n:::\n\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+xlim(0,11)+\n  geom_cladelab(node=104,label=\"Icterus\",geom=\"label\",\nfill=\"yellow\",textcolor=\"red\", barcolor=\"gray\",angle=90)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-23-1.png){width=960}\n:::\n:::\n\n\n## \n\nTambién podemos dibujar una linea entre dos taxa, que pudieran o no estár relacionados, utilizando el parametro *geom_strip*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+xlim(0,15)+\n  geom_strip(\"Quiscalus_quiscula\",\"Icterus_icterus\",\n  label=\" un clado polifilético\", barsize = 2, offset.text = 0.2)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-24-1.png){width=960}\n:::\n:::\n\n\n## \n\nUn parametro de anotación muy bueno, también es el *geom_highlight*, el cual nos permite destacar clados en particular, utilizando los nodos de ancestro en común:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  geom_highlight(node=146,alpha=0.5,fill=\"purple\",type = \"rect\")\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-25-1.png){width=960}\n:::\n:::\n\n\n## \n\n¿Qué clado es este?\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+\n  geom_highlight(node=146,alpha=0.5,fill=\"purple\",type = \"rect\")+\n  geom_cladelab(node=146,label = \"Quiscalus\",offset=0,barcolor=\"#9418f2\",textcolor=\"#4c0980\", offset.text=0)+\n  xlim(0,11.5)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-26-1.png){width=960}\n:::\n:::\n\n\n## \n\nUna función bastante interesante de *ggtree* es que se pueden personalizar las filogenías utilizando recursos en línea como *phylopic* o enriquecerlas con imagenes propias. Para poder hacer uso de esta función, primero debemos cargar un paquete extra:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"rsvg\")\n```\n:::\n\n\n. . .\n\nHacer uso de *phylopic* para personalizar las anotaciones de las filogenias requiere que primero hagamos una tabla con los nodos, el nombre de la especie o clado a los cuales vamos a anotar y el phylopic_id.\n\n## \n\nEn este ejemplo utilizaré los clados *Quiscalus* y *Agelaius*, que sé que tienen imagenes indexadas en *phylopic*. Encontrar los phylopic_id es fácil usando la función *phylopic_uid*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nids<-phylopic_uid(c(\"Quiscalus\",\"Agelaius\"))\nids\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               name                                  uid\nQuiscalus Quiscalus 2ada4e2f-35ab-48d2-b32e-3bad57033dd4\nAgelaius   Agelaius 9a3f70a3-2ea9-45aa-8a1a-7c599952fd6c\n```\n:::\n:::\n\n\nCon estos ids, ya podemos crear nuestra tabla con los datos necesarios y después gráficar nuestra filogenia:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt<-data.frame(node=c(146,136),image=ids$uid,genus=c(\"Quiscalus\",\"Agelaius\"))\ndt\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  node                                image     genus\n1  146 2ada4e2f-35ab-48d2-b32e-3bad57033dd4 Quiscalus\n2  136 9a3f70a3-2ea9-45aa-8a1a-7c599952fd6c  Agelaius\n```\n:::\n:::\n\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+ geom_cladelab(data = dt, \n                      mapping = aes(node = node, label = genus, \n                                    image = image, color = genus), \n                      geom = \"phylopic\", offset = 0, offset.text=0.5)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-30-1.png){width=960}\n:::\n:::\n\n\n## \n\nAdemás, usando la argumentación como en ggplot, podemos personalizar los colores de nuestros *phylopics*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1+ geom_cladelab(data = dt, \n                      mapping = aes(node = node, label = genus, \n                                    image = image, color = genus), \n                      geom = \"phylopic\", offset = 0, offset.text=0.5)+ scale_color_manual(values=c(\"#f75419\",\"purple\"))\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-31-1.png){width=960}\n:::\n:::\n\n\n## \n\nUtilizando estas parametrizaciones, podemos crear una filogenia bastante atractiva:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npr<-p1+ geom_cladelab(data = dt, \n                      mapping = aes(node = node, label = genus, \n                                    image = image, color = genus), \n                      geom = \"phylopic\", offset = 0, offset.text=0.5)+\n  scale_color_manual(values=c(\"#f75419\",\"purple\"))+\n  geom_highlight(node=146,alpha=0.5,fill=\"purple\",type = \"rect\")+\n  geom_highlight(node=136,alpha=0.5,fill=\"#f75419\",type = \"rect\")\npr\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-32-1.png){width=960}\n:::\n:::\n\n\n## \n\ny este es un ejemplo de el tipo de filogenias que pueden crearse haciendo uso de todas estas parametrizaciones:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntree<-read.tree(here(\"data\",\"nodedtree.txt\"))\nnodes<-c(825,725,921,1042,1080,1375,707)\nlabels<-c(\"Parulidae\",\"Icteridae\",\"Passerellidae\",\"Cardinalidae\",\"Thraupidae\",\"Emberizidae\",\"Calcariidae\")\n#\n\niu2<-phylopic_uid(c(\"Setophaga\",\"Quiscalus\",\"Passerellidae\",\"Cardinalis\",\"Thraupidae\",\"Emberizidae\",\"Emberiza\"),seed=1)\n\ndt<-data.frame(node=nodes,name=labels,image=iu2$uid)\n\np2<-ggtree(tree,layout=\"circular\",color=\"white\")+theme_tree(\"black\")\n\np3<-p2+\n  geom_highlight(node=825,fill=\"yellow\")+\n  geom_cladelab(node=825,label=\"Parulidae\",barcolor=\"yellow\",textcolor=\"white\",offset.text=4, fontsize=4)+\n  \n  geom_highlight(node=725,fill=\"orange\")+\n  geom_cladelab(node=725,label=\"Icteridae\",barcolor=\"orange\",textcolor=\"white\",offset.text=5, fontsize=4,angle=45)+\n    \n    geom_highlight(node=921,fill=\"brown\")+\n  geom_cladelab(node=921,label=\"Passerellidae\",barcolor=\"brown\",textcolor=\"white\",offset.text=1, fontsize=4)+\n  \n  geom_highlight(node=1042,fill=\"red\")+\ngeom_cladelab(node=1042,label=\"Cardinalidae\",barcolor=\"red\",textcolor=\"white\",offset.text=7, fontsize=4,angle=-45,align=T)+\n  \n  geom_highlight(node=1079,fill=\"lightgreen\")+\ngeom_cladelab(node=1079,label=\"Thraupidae\",barcolor=\"lightgreen\",textcolor=\"white\",offset.text=2, fontsize=4)+\n  \n  geom_highlight(node=1375,fill=\"magenta\")+\n  geom_cladelab(node=1375,label=\"Emberizidae\",barcolor=\"magenta\",textcolor=\"white\",offset.text=1, fontsize=4,align=T)+\n  \n  geom_highlight(node=707,fill=\"blue\")+\n  geom_cladelab(node=707,label=\"Calcariidae\",barcolor=\"blue\",textcolor=\"white\",offset.text=1, fontsize=4,align=T)\n```\n:::\n\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\np3+\ngeom_cladelab(data = dt, \n              mapping = aes(node = node, label = name, \n                            image = image, color = name), \n              geom = \"phylopic\", offset.text=c(10,7,6,5,9,4,10))+\n  scale_colour_manual(values=c(\"blue\",\"red\",\"magenta\",\"orange\",\"yellow\",\"brown\",\"lightgreen\"))\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-34-1.png){width=960}\n:::\n:::\n\n\n## \n\nPara poder anotar las filogenias con imagenes, es recomendable usar árboles filogéticos pequeños, en los cuales quizá con un grupo de representantes bastaría. En este ejemplo usaremos una filogenia parafiletica con los generos *Quiscalus* (Los zanates), *Icterus* (Las calandrias), *Molothrus* (Los tordos), *Agelaius* (Los sargentos) y *Psarocolius* (Las oropendolas):\n\nEntonces, primero recuperamos un representante de cada grupo, *ape* es muy bueno para esto usando la función *keep.tip*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrouptree<-ictree %>%\nkeep.tip(c(\"Quiscalus_mexicanus\", \"Icterus_galbula\",\"Molothrus_aeneus\",\"Agelaius_phoeniceus\",\"Psarocolius_montezuma\"))\n\ngrouptree$tip.label<-c(\"Calandrias\",\"Sargentos\",\"Zanates\",\"Tordos\",\"Oropendolas\")\n\np4<-ggtree(grouptree,size=1)\n```\n:::\n\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\np4+xlim(0,15)+\n  geom_tiplab(color=\"navyblue\",offset = 0.5)\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-36-1.png){width=960}\n:::\n:::\n\n\n## \n\nUna vez teniendo este árbol parafilético, podemos colocar las imagenes gusto en sus grupos correspondientes, es importante considerar, que las imagenes deben tener el nombre exacto del grupo o especie y el mismo formato:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np4+ \n  xlim(NA, 15) + ylim(NA, 5.5)+\n  geom_tiplab(aes(image=paste0(\"imgs/imagenes/\", label, '.jpg')),geom=\"image\", offset=3, align=1, size=0.18)+\n  geom_tiplab(geom=\"label\",color=\"black\",fill=\"white\")\n```\n:::\n\n\n##\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-38-1.png){width=960}\n:::\n:::\n\n\n## \n\nTambién es posible agregar especies a la filogenia dentro de sus respectivos generos, pero hay que tener cuidado con esto, pues posiblemente nos genere politomías o colocarlas de manera discordante, y esto puede ser problématico para estudios de diversificación o evolución de atributos.\n\n## \n\nVolveremos a usar nuestra filogenia de grupos y le agregaremos dos especies de *Icterus* y una especie de *Quiscalus*\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrouptree<-ictree %>%\nkeep.tip(c(\"Quiscalus_mexicanus\", \"Icterus_galbula\",\"Molothrus_aeneus\",\"Agelaius_phoeniceus\",\"Psarocolius_montezuma\"))\nggtree(grouptree)+\n  xlim(0,15)+\n  geom_tiplab(color=\"blue\")\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-39-1.png){width=960}\n:::\n:::\n\n\n## \n\nPara agregar las especies, utilizamos la función *add.species.to.genus* de *phytools*:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrouptree2<-grouptree\ngrouptree2<-add.species.to.genus(grouptree2,\"Quiscalus_quiscula\")\ngrouptree2<-add.species.to.genus(grouptree2,\"Icterus_bullocki\")\ngrouptree2<-add.species.to.genus(grouptree2,\"Icterus_gullaris\")\nggtree(grouptree2)+\n  xlim(0,20)+\n  geom_tiplab(color=\"blue\")\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-40-1.png){width=960}\n:::\n:::\n\n\n## \n\nFinalmente, se puede usar ggtree, para graficar atributos de las especies en la filogenia.\n\nPara hacer esto, primero debemos cargar los atributos de los Icteridos, en este caso usaremos el Hand Wing Index (HWI) y el hábito migratorio:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhwi<-read.csv(here(\"data\",\"hwi_icteridae.csv\"),header=T)\nhead(hwi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                     X      HWI\n1   Icterus_melanopsis 26.51912\n2    Icterus_northropi 21.02135\n3   Icterus_laudabilis 22.22500\n4 Icterus_dominicensis 26.52877\n5   Icterus_cayanensis 26.26213\n6 Icterus_pyrrhopterus 17.75463\n```\n:::\n:::\n\n\n## \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmigrants<-read.csv(here(\"data\",\"icterimigrants.csv\"),header=T)\nhead(migrants)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   sp  migratory\n1  Agelaioides_badius No-migrant\n2  Agelaius_assimilis No-migrant\n3  Agelaius_humeralis No-migrant\n4 Agelaius_phoeniceus    Migrant\n5   Agelaius_tricolor No-migrant\n6  Agelaius_xanthomus No-migrant\n```\n:::\n:::\n\n\n## \n\nUna vez cargados los datos, la manera más fácil de utilizarlos es uniendolos a la filogenia usando la funcion *full_join*, es importante que las especies estén etiquetadas como label, para que la función las reconozca:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(hwi)<-c(\"label\",\"hwi\")\nnames(migrants)<-c(\"label\",\"migratory\")\n\nhwimigrants<-hwi%>%\nleft_join(migrants,by=\"label\")\ndatatree<-full_join(ictree,hwimigrants,by=\"label\")\ndatatree\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'treedata' S4 object'.\n\n...@ phylo:\n\nPhylogenetic tree with 100 tips and 99 internal nodes.\n\nTip labels:\n  Icterus_melanopsis, Icterus_northropi, Icterus_laudabilis,\nIcterus_dominicensis, Icterus_cayanensis, Icterus_pyrrhopterus, ...\nNode labels:\n  761, 762, 763, 764, 765, 766, ...\n\nRooted; includes branch lengths.\n\nwith the following features available:\n  '', 'hwi', 'migratory'.\n\n# The associated data tibble abstraction: 199 × 5\n# The 'node', 'label' and 'isTip' are from the phylo tree.\n    node label                 isTip   hwi migratory \n   <int> <chr>                 <lgl> <dbl> <chr>     \n 1     1 Icterus_melanopsis    TRUE   26.5 No-migrant\n 2     2 Icterus_northropi     TRUE   21.0 No-migrant\n 3     3 Icterus_laudabilis    TRUE   22.2 No-migrant\n 4     4 Icterus_dominicensis  TRUE   26.5 No-migrant\n 5     5 Icterus_cayanensis    TRUE   26.3 No-migrant\n 6     6 Icterus_pyrrhopterus  TRUE   17.8 No-migrant\n 7     7 Icterus_auricapillus  TRUE   17.3 No-migrant\n 8     8 Icterus_bonana        TRUE   16.9 No-migrant\n 9     9 Icterus_portoricensis TRUE   22.3 No-migrant\n10    10 Icterus_prosthemelas  TRUE   24.1 No-migrant\n# ℹ 189 more rows\n```\n:::\n:::\n\n\n## \n\n¡Listo! Ahora tenemos una filogenia con atributos y podemos gráficarlos juntos\n\nPrimero gráficaremos los valores continuos del HWI sobre las puntas del árbol en una escala de colores:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np5<-ggtree(datatree)\np5+\n  geom_tippoint(aes(color=hwi))\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-44-1.png){width=960}\n:::\n:::\n\n\n## \n\npodemos también personalizar esta escala:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np5+\n  geom_tippoint(aes(color=hwi),shape=15)+\n  scale_colour_gradient(low='blue', high='red',breaks= c(15,20,25,30,35))\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-45-1.png){width=960}\n:::\n:::\n\n\n## \n\n¿Y cómo se verían los datos binarios?\n\n\n::: {.cell}\n\n```{.r .cell-code}\np5+\n  geom_tippoint(aes(color=migratory),shape=15)+\n    scale_colour_manual(values = c(\"green\",\"orange\"))\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-46-1.png){width=960}\n:::\n:::\n\n\n## \n\ny ¿Pueden combinarse?\n\nEsto puede hacerse con un lenguaje de *dplyr*\n\n\n::: {.cell}\n\n```{.r .cell-code}\npx<- py%<+% migrants + geom_tippoint(aes(color=migratory),shape=15)+\n  scale_color_manual(values = c(\"#961d29\",\"#1420a3\"))+\n  scale_fill_manual(values = c(\"#961d29\",\"#1420a3\"))\n  \n  \npx+ geom_facet(panel=\"HWI\",data = hwi,geom=geom_col,mapping=aes(x=hwi,color=migratory,fill=migratory),orientation='y')+\n    theme_tree2()\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-47-1.png){width=960}\n:::\n:::\n\n\n##\n\nPero, ¿Qué pasa si no me sé la taxonomía o no tengo la filogenía del grupo que estoy estudiando?\n\n\n\n\n##\n\n¿Se acuerdan de esta filogenia?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nphylopicNK\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-49-1.png){width=960}\n:::\n:::\n\n\n##\n\nHaciendo uso de recursos en línea como *Open tree of Life*(OTL), podemoos obtener una filogenia utilizando las especies que necesitemos.\n\n##\n\nOTL tiene un útil paquete en R (`rotl`), que usaremos para obtener la filogenia con la planta, aves y mamiferos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"rotl\")\notl_tree<-rotl::tnrs_match_names(c(\"Quiscalus mexicanus\",\"Canis lupus\",\"Corvus corax\",\"Canis latrans\",\"Vulpes vulpes\",\"Desmodus rotundus\",\"Sideroxylon celastrinum\")) %>% \n  pull(ott_id) %>% \n  tol_induced_subtree(label_format=\"name\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nProgress [---------------------------------] 0/211 (  0%) ?s\nProgress [==============================] 211/211 (100%)  0s\n                                                            \n```\n:::\n:::\n\n\n##\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_ott<-ggtree(otl_tree)+\n  xlim(0,9)+\n  geom_tiplab(color=\"blue\")\np_ott\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-51-1.png){width=960}\n:::\n:::\n\n\n##\nPara la función de `rtol`, no es necesario introducir las especies en orden, ya que ésta recuperará la taxonomia válida y nos arrojará una filogenia podada.\n\nEn este caso, OTL nos regresó exactamente la misma filogenia que creamos al principio:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_nk<-ggtree(Nktree)+\n  xlim(0,9)+\n  geom_tiplab(color=\"red\")\n\np_ott/p_nk\n```\n\n::: {.cell-output-display}\n![](5.4-filogenias_files/figure-revealjs/unnamed-chunk-52-1.png){width=960}\n:::\n:::\n\n##\n",
    "supporting": [
      "5.4-filogenias_files/figure-revealjs"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}